name: Reusable - Scan Image For Vulnerabilities 🛡️🔍
run-name: Scan Image For Vulnerabilities 🛡️🔍

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the container image to build'
        required: true
        default: ''
        type: string
      image_tag:
        description: 'Tag for the container image to build'
        required: false
        default: 'ci-container-build'
        type: string
      registry:
        description: 'Registry to push to'
        required: true
        default: ''
        type: string
      username:
        description: 'Username for the registry'
        required: true
        default: ''
        type: string

jobs:
  trivy-scan-and-upload:
    name: Scan Image For Vulnerabilities 🛡️🔍
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    permissions:
      # for actions/checkout to fetch code
      contents: read
      # for github/codeql-action/upload-sarif to upload SARIF results
      security-events: write
      # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
      actions: read
    steps:
      # https://github.com/marketplace/actions/aqua-security-trivy
      - name: Scan Image For Vulnerabilities 🛡️🔍
        id: trivy-scan
        uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4 # 0.32.0
        with:
          image-ref: ${{ inputs.registry }}/${{ inputs.username }}/${{ inputs.image_name }}:${{ inputs.image_tag }}
          format: sarif
          output: trivy-results.sarif
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret'

      # https://github.com/github/codeql-action
      # https://github.com/github/codeql-action/blob/main/upload-sarif/action.yml
      - name: Upload Trivy Scan Results To GitHub Security Tab 🛡️⬆️
        id: upload-trivy-results
        uses: github/codeql-action/upload-sarif@51f77329afa6477de8c49fc9c7046c15b9a4e79d # v3.29.5
        if: always()
        with:
          sarif_file: trivy-results.sarif
